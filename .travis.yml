---
language: python

sudo: required

services:
  - docker

branches:
  only:
    - master

env:
  global:
    # Software versions
    - TERRAFORM_VERSION=0.11.10
    - YAMLLINT_VERSION=1.8.1
    - TERRAFORM_PROVIDER_RKE_VERSION=0.5.0
    # SSH
    - TF_VAR_ssh_key="ssh_key"
    - TF_VAR_ssh_key_pub="ssh_key.pub"
    # OpenStack environment
    - OS_AUTH_URL="https://pouta.csc.fi:5001/v3"
    - OS_PROJECT_ID="glenna"
    - OS_PROJECT_NAME="glenna"
    - OS_USER_DOMAIN_NAME="Default"
    - OS_USERNAME="marca"
    - OS_REGION_NAME="regionOne"
    - OS_IDENTITY_API_VERSION=3
    - TF_VAR_external_network_id="26f9344a-2e81-4ef5-a018-7d20cff891ee"
    - TF_VAR_floating_ip_pool="public"
    - TF_VAR_image_name="Ubuntu-16.04"
    - TF_VAR_master_flavor_name="standard.large"
    - TF_VAR_worker_flavor_name="standard.large"
    - secure: >
        YkqneBUKw1r1/htOFryPndKGXMTT1qCJvYEp5qITul+TytdKvSBo35e3lPw5uUjpEPAo
        FDPVwgPdO+HOM+H5DPlXdUcCMEay6z6j8vJPGYafIAUV/j5upPpeWG0XPgaFzFZ66pHa
        qc1wbhWW4b9IKH8xOrs/GzZk+Len3HVO0oBgKuzMXWlIWdny6lhjOsWjIktvAvG/OKdm
        7+3iriWc+H2IWMaFI9FRYTO38dNf6dLXGIm1qZxP3bWV8CFbmFZzr7K1aY6rVuMjgt4f
        VmOoCSnYNpoaXUcW3rfc3ral/o4x8sbz+VYWxrV/2QgjyMWv8NMKpdXg8xEgH4TM7PuP
        It4r+gJlgSl7wilOwKBhCTsVaBpBlfRKJ0WL3sjmjfEEt3+Ye5zjmniDvm5g9rzk6kGe
        hXvmwmye0OY9dUrfp6kNgh0DwP9qvPEemcPsyBsEg4fTkLW00sBHtY3jcU4AgdMtgnlS
        nyBN6j2emgXk0Uh/vfhJ25I6xT+7peH8SHPa55E+QzeXeB9dbbj6+hl7f9o1ki4p/pHR
        eMB1ZfM5BRrnx9NMuvNpIB8KAQuEq+PwCJ9GFOx+HWZcRMjq48f70cxDtkyMJfd54rP4
        44H1iemlg9sbIicdE7a20ZICXSh5iXP1Mhv0L0r/4L3W2gD34NscTuhrizsMR7+uHurr
        0Qo=
  matrix:
    - >
      TF_VAR_cluster_prefix=rke-ci-$TRAVIS_BUILD_NUMBER
      TF_VAR_master_count=1
      TF_VAR_worker_count=1
    - >
      TF_VAR_cluster_prefix=rke-ci-ha-$TRAVIS_BUILD_NUMBER
      TF_VAR_master_count=3
      TF_VAR_worker_count=1

install:
  # Install Terraform
  - >
    travis_retry curl -L
    "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip"
    -o /tmp/terraform.zip
  - sudo unzip /tmp/terraform.zip -d /usr/bin
  - sudo chmod +x /usr/bin/terraform
  # Install terraform-provider-rke
  - travis_retry curl -L
    "https://github.com/yamamoto-febc/terraform-provider-rke/releases/download/${TERRAFORM_PROVIDER_RKE_VERSION}/terraform-provider-rke_${TERRAFORM_PROVIDER_RKE_VERSION}_linux-amd64.zip"
    -o /tmp/teraform-provider-rke.zip
  - mkdir -p "$HOME/.terraform.d/plugins/"
  - unzip /tmp/teraform-provider-rke.zip -d $HOME/.terraform.d/plugins/
  # Install yamllint
  - sudo pip install yamllint==$YAMLLINT_VERSION
  # Configure SSH key
  - ssh-keygen -t rsa -N '' -f ssh_key
  - eval "$(ssh-agent -s)"
  - ssh-add ssh_key

before_script:
  # Terraform init, validate, and format check
  - terraform init
  - terraform validate
  - terraform fmt -check=true -diff
  # Check YAMLs
  - yamllint -c .yamllint.yml -s $(find . -type f -name '*.yml')

script:
  # Deploy
  - terraform apply -auto-approve # this also runs sanity checks

after_script:
  # Destroy
  - terraform destroy -force
